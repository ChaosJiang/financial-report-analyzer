name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

x-shared-steps:
  - &checkout
    uses: actions/checkout@v6
  - &install-uv
    name: Install uv
    uses: astral-sh/setup-uv@v7
    with:
      version: "latest"
  - &setup-python
    name: Set up Python
    uses: actions/setup-python@v6
    with:
      python-version: "3.11"

jobs:
  lint:
    name: Lint with Ruff
    runs-on: ubuntu-latest
    steps:
      - *checkout
      - *install-uv
      - *setup-python

      - name: Install Ruff with uv
        run: uv pip install --system ruff

      - name: Run Ruff linter
        run: |
          ruff check scripts/ \
            --select E,F,W,I,N,UP,YTT,ASYNC,S,BLE,B,A,COM,C4,DTZ,T10,EM,ISC,G,PIE,PYI,RSE,RET,SIM,TID,TCH,ARG,PTH,PD,PGH,PL,TRY,NPY,RUF \
            --ignore \
              E501, \
              COM812, \
              ISC001 \
            --output-format=github

      - name: Run Ruff formatter check
        run: |
          ruff format --check scripts/

  type-check:
    name: Type Check with MyPy
    runs-on: ubuntu-latest
    steps:
      - *checkout
      - *install-uv
      - *setup-python

      - name: Install dependencies with uv
        run: |
          uv pip install --system -r scripts/requirements.txt
          uv pip install --system mypy types-requests types-PyYAML

      - name: Run MyPy
        continue-on-error: true
        run: |
          mypy scripts/ --ignore-missing-imports --no-strict-optional

  test:
    name: Test scripts
    runs-on: ubuntu-latest
    steps:
      - *checkout
      - *install-uv
      - *setup-python

      - name: Install dependencies with uv
        run: uv pip install --system -r scripts/requirements.txt

      - name: Compile scripts
        run: python -m compileall scripts/

      - name: Test fetch_data.py
        run: python scripts/fetch_data.py --help

      - name: Test analyze.py
        run: python scripts/analyze.py --help

      - name: Test valuation.py
        run: python scripts/valuation.py --help

      - name: Test analyst.py
        run: python scripts/analyst.py --help

      - name: Test visualize.py
        run: python scripts/visualize.py --help

      - name: Test report.py
        run: python scripts/report.py --help

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    steps:
      - *checkout
      - *install-uv
      - *setup-python

      - name: Install dependencies with uv
        run: uv pip install --system -r scripts/requirements.txt

      - name: Run end-to-end test
        run: |
          mkdir -p test_output
          python scripts/fetch_data.py --symbol AAPL --market US --years 1 --output test_output
          python scripts/analyze.py --input test_output/AAPL_data.json --output test_output
          python scripts/valuation.py --input test_output/AAPL_data.json --analysis test_output/AAPL_analysis.json --output test_output
          python scripts/analyst.py --input test_output/AAPL_data.json --output test_output
          python scripts/visualize.py --analysis test_output/AAPL_analysis.json --output test_output/AAPL_charts
          python scripts/report.py --analysis test_output/AAPL_analysis.json --valuation test_output/AAPL_valuation.json --analyst test_output/AAPL_analyst.json --output test_output

      - name: Verify outputs
        run: |
          test -f test_output/AAPL_data.json || exit 1
          test -f test_output/AAPL_analysis.json || exit 1
          test -f test_output/AAPL_valuation.json || exit 1
          test -f test_output/AAPL_analyst.json || exit 1
          test -f test_output/AAPL_report.md || exit 1
          test -d test_output/AAPL_charts || exit 1
          echo "All outputs generated successfully"

      - name: Upload output artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test_output/
          retention-days: 7
