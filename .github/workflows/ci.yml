name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  lint:
    name: Lint with Ruff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ruff with uv
        run: uv pip install ruff

      - name: Run Ruff linter
        run: |
          ruff check scripts/ \
            --select E,F,W,I,N,UP,YTT,ASYNC,S,BLE,B,A,COM,C4,DTZ,T10,EM,ISC,G,PIE,PYI,RSE,RET,SIM,TID,TCH,ARG,PTH,PD,PGH,PL,TRY,NPY,RUF \
            --ignore \
              E501, \
              COM812, \
              ISC001 \
            --output-format=github

      - name: Run Ruff formatter check
        run: |
          ruff format --check scripts/

  type-check:
    name: Type Check with MyPy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies with uv
        run: |
          uv pip install -r scripts/requirements.txt
          uv pip install mypy types-requests types-PyYAML

      - name: Run MyPy
        continue-on-error: true
        run: |
          mypy scripts/ --ignore-missing-imports --no-strict-optional

  test:
    name: Test scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies with uv
        run: uv pip install -r scripts/requirements.txt

      - name: Compile scripts
        run: python -m compileall scripts/

      - name: Test fetch_data.py
        run: python scripts/fetch_data.py --help

      - name: Test analyze.py
        run: python scripts/analyze.py --help

      - name: Test valuation.py
        run: python scripts/valuation.py --help

      - name: Test analyst.py
        run: python scripts/analyst.py --help

      - name: Test visualize.py
        run: python scripts/visualize.py --help

      - name: Test report.py
        run: python scripts/report.py --help

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies with uv
        run: uv pip install -r scripts/requirements.txt

      - name: Run end-to-end test
        run: |
          mkdir -p test_output
          python scripts/fetch_data.py --symbol AAPL --market US --years 1 --output test_output
          python scripts/analyze.py --input test_output/AAPL_data.json --output test_output
          python scripts/valuation.py --input test_output/AAPL_data.json --analysis test_output/AAPL_analysis.json --output test_output
          python scripts/analyst.py --input test_output/AAPL_data.json --output test_output
          python scripts/visualize.py --analysis test_output/AAPL_analysis.json --output test_output/AAPL_charts
          python scripts/report.py --analysis test_output/AAPL_analysis.json --valuation test_output/AAPL_valuation.json --analyst test_output/AAPL_analyst.json --output test_output

      - name: Verify outputs
        run: |
          test -f test_output/AAPL_data.json || exit 1
          test -f test_output/AAPL_analysis.json || exit 1
          test -f test_output/AAPL_valuation.json || exit 1
          test -f test_output/AAPL_analyst.json || exit 1
          test -f test_output/AAPL_report.md || exit 1
          test -d test_output/AAPL_charts || exit 1
          echo "All outputs generated successfully"

      - name: Upload output artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test_output/
          retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install security tools with uv
        run: uv pip install bandit safety

      - name: Run Bandit security linter
        continue-on-error: true
        run: |
          bandit -r scripts/ -f json -o bandit-report.json || true
          bandit -r scripts/

      - name: Check for security vulnerabilities
        continue-on-error: true
        run: |
          uv pip install -r scripts/requirements.txt
          safety check --json || true

  build:
    name: Build with uv
    runs-on: ubuntu-latest
    needs: [lint, type-check, test]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build package with uv
        run: |
          uv build --verbose

      - name: List build artifacts
        run: ls -lh dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  publish:
    name: Publish to PyPI (manual trigger)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
    environment:
      name: pypi
      url: https://pypi.org/p/financial-report-analyzer
    permissions:
      id-token: write  # REQUIRED for trusted publishing
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI with uv
        run: uv publish --token __token__
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          UV_PUBLISH_URL: https://upload.pypi.org/legacy/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
          body_path: .github/release/v${{ github.ref_name }}.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
